<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adama EBIRR KPI System</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Poppins,sans-serif; background: linear-gradient(135deg,#ffe0b2,#ffccbc); margin:0; padding:20px;}
.logo{ display:block; margin:0 auto 20px; width:120px; height:120px; border-radius:50%; box-shadow:0 5px 20px rgba(0,0,0,0.3);}
.card{ background:white; padding:30px; margin:20px auto; border-radius:20px; box-shadow:0 15px 40px rgba(0,0,0,0.25); max-width:1200px; width:95%;}
h2{ color:#00796b; text-align:center; margin-bottom:20px;}
input,select,textarea{ width:100%; padding:12px; margin-top:10px; border-radius:12px; border:1px solid #ccc; box-sizing:border-box;}
button{ padding:12px; width:100%; margin-top:15px; border:none; border-radius:12px; background:#00796b; color:white; font-weight:bold; cursor:pointer;}
.hidden{display:none}
.customer-card{ background:#e0f2f1; padding:15px; margin-bottom:15px; border-radius:15px; display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px;}
#kpiTableContainer{ max-height:400px; overflow-y:auto; margin-top:20px;}
#kpiTable{ width:100%; border-collapse:collapse;}
#kpiTable th, #kpiTable td{ padding:8px; border:1px solid #ccc; text-align:center;}
#kpiTable th{ background:#00796b; color:white; position:sticky; top:0;}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginPage">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<!-- ADMIN DASHBOARD -->
<div class="card hidden" id="adminDashboard">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Admin Dashboard</h2>
<button onclick="showPage('registerPage')">Register Staff</button>
<button onclick="showPage('staffList'); loadStaff()">View Staff</button>
<button onclick="showPage('kpiView'); loadKPI()">View KPI</button>
<button onclick="logout()">Logout</button>
</div>

<!-- REGISTER STAFF -->
<div class="card hidden" id="registerPage">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Register Staff</h2>
<input id="rname" placeholder="Name">
<input id="remail" placeholder="Email">
<input id="rpass" placeholder="Password">
<select id="rrole">
<option value="user">User</option>
<option value="admin">Admin</option>
</select>
<button onclick="registerStaff()">Register</button>
<button onclick="showPage('adminDashboard')">Back</button>
</div>

<!-- STAFF LIST -->
<div class="card hidden" id="staffList">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Staff List</h2>
<table>
<thead>
<tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr>
</thead>
<tbody id="staffTable"></tbody>
</table>
<button onclick="showPage('adminDashboard')">Back</button>
</div>

<!-- KPI VIEW -->
<div class="card hidden" id="kpiView">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>KPI Reports (All Staff)</h2>
<canvas id="chart"></canvas>
<button onclick="exportKPIToExcel()">ðŸ“¥ Export KPI to Excel</button>

<div id="kpiTableContainer">
<table id="kpiTable">
<thead>
<tr>
<th>Staff</th><th>Branch</th><th>Customer</th><th>Phone</th><th>Date</th>
<th>Reg</th><th>Upd</th><th>App</th><th>PIN</th><th>Delete</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<button onclick="showPage('adminDashboard')">Back</button>
</div>

<!-- STAFF DASHBOARD -->
<div class="card hidden" id="staffDashboard">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Submit & Share Customer KPI</h2>

<input type="date" id="date">
<input id="staff" placeholder="Your Name">
<input id="branch" placeholder="Branch Name">

<h3>Daily Activity</h3>
<input id="stickers" type="number" placeholder="Total Stickers">
<input id="shopVisit" type="number" placeholder="Total Shop Visit">
<input id="pedestrianVisit" type="number" placeholder="Total Pedestrian Labels">

<h3>Customer Engagements</h3>
<div id="customers"></div>
<button onclick="addCustomer()">âž• Add Customer</button>

<h3>Customer Feedback</h3>
<textarea id="customerFeedback" rows="4"></textarea>

<h3>Totals: <span id="totals">Reg:0 | Upd:0 | App:0 | PIN:0</span></h3>

<button onclick="submitAndShareKPI()">Submit & Share KPI</button>
<button onclick="logout()">Logout</button>
</div>

<script>
// Firebase
firebase.initializeApp({
apiKey:"AIzaSyCXyyloL62I-Mc7bqLSqjEoc3XETzXHgSc",
authDomain:"marketing-kpi-system.firebaseapp.com",
projectId:"marketing-kpi-system"
});

const auth = firebase.auth();
const db = firebase.firestore();
let customerList=[];

// NAV
function showPage(id){
document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
}

// LOGIN
function login(){
auth.signInWithEmailAndPassword(val("email"), val("password"))
.then(r => db.collection("users").doc(r.user.uid).get())
.then(doc=>{
if(doc.exists){
const role = doc.data().role;
if(role==="admin") showPage("adminDashboard");
else showPage("staffDashboard");
}
});
}

// LOGOUT
function logout(){
auth.signOut();
showPage("loginPage");
}

// REGISTER
async function registerStaff(){
let u = await auth.createUserWithEmailAndPassword(val("remail"), val("rpass"));
await db.collection("users").doc(u.user.uid).set({
name: val("rname"),
email: val("remail"),
role: val("rrole")
});
alert("Staff Registered");
}

// CUSTOMERS
function addCustomer(){
const div=document.createElement("div");
div.classList.add("customer-card");
div.innerHTML=`
<input placeholder="Customer Name" class="cname">
<input placeholder="Phone" class="cphone">
<label><input type="checkbox" class="creg" checked> Registration</label>
<label><input type="checkbox" class="cupdate"> Update</label>
<label><input type="checkbox" class="capp"> App</label>
<label><input type="checkbox" class="cpin"> PIN</label>
<button onclick="removeCustomer(this)">Remove</button>
`;
document.getElementById("customers").appendChild(div);
customerList.push(div);
updateTotals();
}

function removeCustomer(btn){
const div=btn.parentElement;
div.remove();
customerList=customerList.filter(c=>c!==div);
updateTotals();
}

function updateTotals(){
let reg=0,upd=0,app=0,pin=0;
customerList.forEach(c=>{
if(c.querySelector(".creg").checked) reg++;
if(c.querySelector(".cupdate").checked) upd++;
if(c.querySelector(".capp").checked) app++;
if(c.querySelector(".cpin").checked) pin++;
});
document.getElementById("totals").innerText=`Reg:${reg} | Upd:${upd} | App:${app} | PIN:${pin}`;
}

// SUBMIT
async function submitAndShareKPI(){
for(const c of customerList){
await db.collection("kpi").add({
date: val("date"),
staff: val("staff"),
branch: val("branch"),
customer: c.querySelector(".cname").value,
phone: c.querySelector(".cphone").value,
reg: c.querySelector(".creg").checked?1:0,
upd: c.querySelector(".cupdate").checked?1:0,
app: c.querySelector(".capp").checked?1:0,
pin: c.querySelector(".cpin").checked?1:0
});
}
alert("KPI Submitted");
}

// ADMIN
async function loadStaff(){
const tbody=document.getElementById("staffTable");
tbody.innerHTML="";
const snapshot=await db.collection("users").get();
snapshot.forEach(doc=>{
const d=doc.data();
tbody.innerHTML+=`
<tr>
<td>${d.name}</td>
<td>${d.email}</td>
<td>${d.role}</td>
<td><button onclick="deleteStaff('${doc.id}')">Delete</button></td>
</tr>`;
});
}

async function deleteStaff(id){
await db.collection("users").doc(id).delete();
loadStaff();
}

let kpiChart;

async function loadKPI(){
const tbody=document.querySelector("#kpiTable tbody");
tbody.innerHTML="";

const snapshot=await db.collection("kpi").get();

let labels=[],data=[];

snapshot.forEach(doc=>{
const d=doc.data();

tbody.innerHTML+=`
<tr>
<td>${d.staff}</td>
<td>${d.branch}</td>
<td>${d.customer}</td>
<td>${d.phone}</td>
<td>${d.date}</td>
<td>${d.reg}</td>
<td>${d.upd}</td>
<td>${d.app}</td>
<td>${d.pin}</td>
<td><button onclick="deleteKPI('${doc.id}')">Delete</button></td>
</tr>`;

labels.push(d.staff);
data.push((d.reg||0)+(d.upd||0)+(d.app||0)+(d.pin||0));
});

const ctx=document.getElementById("chart").getContext("2d");
if(kpiChart) kpiChart.destroy();

kpiChart=new Chart(ctx,{
type:'bar',
data:{labels:labels,datasets:[{label:'Total KPI',data:data,backgroundColor:'#00796b'}]}
});
}

async function deleteKPI(id){
await db.collection("kpi").doc(id).delete();
loadKPI();
}

// EXCEL
function exportKPIToExcel(){
const wb=XLSX.utils.book_new();
const ws=XLSX.utils.table_to_sheet(document.getElementById("kpiTable"));
XLSX.utils.book_append_sheet(wb,ws,"KPI");
XLSX.writeFile(wb,"KPI_Report.xlsx");
}

function val(id){ return document.getElementById(id).value; }

auth.onAuthStateChanged(u=>{ if(!u) showPage("loginPage"); });

</script>
</body>
</html>
