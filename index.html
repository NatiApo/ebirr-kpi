<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adama EBIRR KPI System</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
body { font-family: Poppins,sans-serif; background: linear-gradient(135deg,#ffe0b2,#ffccbc); margin:0; padding:20px;}
.logo{ display:block; margin:0 auto 20px; width:120px; height:120px; border-radius:50%; box-shadow:0 5px 20px rgba(0,0,0,0.3);}
.card{ background:white; padding:30px; margin:20px auto; border-radius:20px; box-shadow:0 15px 40px rgba(0,0,0,0.25); max-width:1200px; width:95%; transition:.3s;}
.card:hover{transform:translateY(-5px);}
h2{ color:#00796b; text-align:center; margin-bottom:20px;}
input,select,textarea{ width:100%; padding:12px; margin-top:10px; border-radius:12px; border:1px solid #ccc; box-sizing:border-box;}
button{ padding:12px; width:100%; margin-top:15px; border:none; border-radius:12px; background:#00796b; color:white; font-weight:bold; cursor:pointer; transition:.3s;}
button:hover{ box-shadow:0 10px 25px rgba(0,150,115,.4); transform:translateY(-2px);}
.hidden{display:none}
.customer-card{ background:#e0f2f1; padding:15px; margin-bottom:15px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px;}
textarea{resize:none;}
#kpiTableContainer{ max-height:400px; overflow-y:auto; margin-top:20px;}
#kpiTable{ width:100%; border-collapse:collapse;}
#kpiTable th, #kpiTable td{ padding:8px; border:1px solid #ccc; text-align:center;}
#kpiTable th{ background:#00796b; color:white; position:sticky; top:0; z-index:1;}
#kpiTable tr:nth-child(even){background:#f1f8f7;}
canvas{ max-width:100%; margin-bottom:20px;}
#map{width:100%;height:500px;border-radius:20px;}
.customer-checkbox{ margin-right:5px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="card" id="loginPage">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<!-- ADMIN DASHBOARD -->
<div class="card hidden" id="adminDashboard">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Admin Dashboard</h2>
<button onclick="showPage('registerPage')">Register Staff</button>
<button onclick="showPage('staffList'); loadStaff()">View Staff</button>
<button onclick="showPage('kpiView'); loadKPI()">View KPI</button>
<button onclick="showPage('staffMap'); loadStaffMap()">View Staff Locations</button>
<button onclick="logout()">Logout</button>
</div>

<!-- REGISTER STAFF -->
<div class="card hidden" id="registerPage">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Register Staff</h2>
<input id="rname" placeholder="Name">
<input id="remail" placeholder="Email">
<input id="rpass" placeholder="Password">
<select id="rrole">
<option value="user">User</option>
<option value="admin">Admin</option>
</select>
<button onclick="registerStaff()">Register</button>
<button onclick="showPage('adminDashboard')">Back</button>
</div>

<!-- STAFF LIST -->
<div class="card hidden" id="staffList">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Staff List</h2>
<table>
<thead>
<tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr>
</thead>
<tbody id="staffTable"></tbody>
</table>
<button onclick="showPage('adminDashboard')">Back</button>
</div>

<!-- KPI VIEW -->
<div class="card hidden" id="kpiView">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>KPI Reports (All Staff)</h2>
<canvas id="chart"></canvas>
<button onclick="exportKPIToExcel()">ðŸ“¥ Export KPI to Excel</button>
<div id="kpiTableContainer">
<table id="kpiTable">
<thead>
<tr>
<th>Staff</th><th>Branch</th><th>Customer</th><th>Phone</th><th>Date</th><th>Reg</th><th>Upd</th><th>App</th><th>PIN</th><th>Delete</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<button onclick="showPage('adminDashboard')">Back</button>
</div>

<!-- STAFF MAP -->
<div class="card hidden" id="staffMap">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Staff Locations (GPS Active Only)</h2>
<div id="map"></div>
<button onclick="showPage('adminDashboard')">Back</button>
</div>

<!-- STAFF DASHBOARD -->
<div class="card hidden" id="staffDashboard">
<img src="https://i.ibb.co/BHMpvLFh/Banner.png" class="logo">
<h2>Submit & Share Customer KPI</h2>
<input type="date" id="date">
<input id="staff" placeholder="Your Name">
<input id="branch" placeholder="Branch Name">
<h3>Daily Activity</h3>
<input id="stickers" type="number" placeholder="Total Stickers">
<input id="shopVisit" type="number" placeholder="Total Shop Visit">
<input id="pedestrianVisit" type="number" placeholder="Total Pedestrian Labels">
<h3>Customer Engagements</h3>
<div id="customers"></div>
<button onclick="addCustomer()">âž• Add Customer</button>
<h3>Customer Feedback</h3>
<textarea id="customerFeedback" placeholder="Enter feedback here..." rows="4"></textarea>
<h3>Totals: <span id="totals">Reg:0 | Upd:0 | App:0 | PIN:0</span></h3>
<button onclick="submitAndShareKPI()">Submit & Share KPI</button>
<button onclick="logout()">Logout</button>
</div>

<script>
// Firebase init
firebase.initializeApp({
  apiKey:"AIzaSyCXyyloL62I-Mc7bqLSqjEoc3XETzXHgSc",
  authDomain:"marketing-kpi-system.firebaseapp.com",
  projectId:"marketing-kpi-system"
});
const auth = firebase.auth();
const db = firebase.firestore();
let staffLat=null, staffLng=null;
let customerList=[];

// ---------- NAVIGATION ----------
function showPage(id){
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// ---------- LOGIN ----------
function login(){
  auth.signInWithEmailAndPassword(val("email"), val("password"))
    .then(r => db.collection("users").doc(r.user.uid).get())
    .then(doc => {
      if(doc.exists){
        const role = doc.data().role;
        detectLocation();
        if(role==="admin") showPage("adminDashboard");
        else showPage("staffDashboard");
      } else alert("User not found!");
    })
    .catch(e=>alert(e.message));
}

// ---------- LOGOUT ----------
function logout(){
  auth.signOut();
  showPage("loginPage");
}

// ---------- REGISTER STAFF ----------
async function registerStaff(){
  try{
    let u = await auth.createUserWithEmailAndPassword(val("remail"), val("rpass"));
    await db.collection("users").doc(u.user.uid).set({
      name: val("rname"),
      email: val("remail"),
      role: val("rrole")
    });
    alert("Staff Registered");
  } catch(e){ alert(e.message); }
}

// ---------- CUSTOMER KPI ----------
function addCustomer(){
  const div = document.createElement("div");
  div.classList.add("customer-card");
  div.innerHTML = `<input type="text" placeholder="Customer Name" class="cname">
  <input type="text" placeholder="Phone Number" class="cphone">
  <label><input type="checkbox" class="creg" checked> Registration + Transaction</label>
  <label><input type="checkbox" class="cupdate"> Update / Level Up</label>
  <label><input type="checkbox" class="capp"> App Download</label>
  <label><input type="checkbox" class="cpin"> PIN Reset</label>
  <button onclick="removeCustomer(this)">Remove</button>`;
  document.getElementById("customers").appendChild(div);
  customerList.push(div);
  updateTotals();
}

function removeCustomer(btn){
  const div = btn.parentElement;
  div.remove();
  customerList = customerList.filter(c=>c!==div);
  updateTotals();
}

function updateTotals(){
  let reg=0, upd=0, app=0, pin=0;
  customerList.forEach(c=>{
    if(c.querySelector(".creg").checked) reg++;
    if(c.querySelector(".cupdate").checked) upd++;
    if(c.querySelector(".capp").checked) app++;
    if(c.querySelector(".cpin").checked) pin++;
  });
  document.getElementById("totals").innerText = `Reg:${reg} | Upd:${upd} | App:${app} | PIN:${pin}`;
}

// ---------- SUBMIT & SHARE KPI ----------
async function submitAndShareKPI(){
  const date = val("date");
  const staffName = val("staff");
  const branch = val("branch");
  const stickers = Number(val("stickers")) || 0;
  const shopVisit = Number(val("shopVisit")) || 0;
  const pedestrianVisit = Number(val("pedestrianVisit")) || 0;
  const feedback = val("customerFeedback");

  // Save each customer KPI to Firestore
  for(const c of customerList){
    await db.collection("kpi").add({
      date, staff: staffName, branch,
      customer: c.querySelector(".cname").value,
      phone: c.querySelector(".cphone").value,
      reg: c.querySelector(".creg").checked?1:0,
      upd: c.querySelector(".cupdate").checked?1:0,
      app: c.querySelector(".capp").checked?1:0,
      pin: c.querySelector(".cpin").checked?1:0,
      lat: staffLat,
      lng: staffLng
    });
  }

  // Build report text
  let report = `âš¡ ${branch} EBIRR TEAM DAILY REPORT âš¡
ðŸ“… Date: ${date}
ðŸ‘¥ Team: Only 1
ðŸ§‘â€ðŸ’¼ Marketer: ${staffName}
ðŸ“ Location: Main

ðŸ†• Registrations: ${stickers}
ðŸ”„ Updates: ${pedestrianVisit}
ðŸ“± App Downloads: ${stickers}
ðŸ”‘ PIN Resets: ${shopVisit}

ðŸ‘¥ CUSTOMER ENGAGEMENTS:
`;

  customerList.forEach((c,i)=>{
    const name = c.querySelector(".cname").value;
    const phone = c.querySelector(".cphone").value;
    let actions=[];
    if(c.querySelector(".creg").checked) actions.push("Registration + Transaction");
    if(c.querySelector(".cupdate").checked) actions.push("Update / Level Up");
    if(c.querySelector(".capp").checked) actions.push("App Download");
    if(c.querySelector(".cpin").checked) actions.push("PIN Reset");
    report += `${i+1}. ${name} | ${phone} | ${actions.join(", ")}\n`;
  });

  report += `
ðŸª Shops: ${stickers}
ðŸš¶ Visits: ${shopVisit}
ðŸ·ï¸ Stickers: ${pedestrianVisit}

ðŸ’¬ Feedback:
${feedback}

---
`;

  // Share or copy
  if(navigator.share){
    navigator.share({title:"EBIRR Daily Report", text:report}).catch(err=>alert("Share canceled"));
  } else {
    navigator.clipboard.writeText(report);
    alert("Report submitted and copied! You can now paste it anywhere.");
  }
  alert("KPI submitted successfully!");
}

// ---------- AUTO DETECT LOCATION ----------
function detectLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      staffLat = pos.coords.latitude;
      staffLng = pos.coords.longitude;
    }, err=>alert("GPS location not available"));
  } else alert("Geolocation not supported");
}

// ---------- ADMIN FUNCTIONS ----------
async function loadStaff(){
  const tbody = document.getElementById("staffTable");
  tbody.innerHTML = "";
  const snapshot = await db.collection("users").get();
  snapshot.forEach(doc=>{
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${data.name}</td><td>${data.email}</td><td>${data.role}</td>
    <td><button onclick="deleteStaff('${doc.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

async function deleteStaff(uid){
  if(confirm("Are you sure you want to delete this staff?")){
    await db.collection("users").doc(uid).delete();
    loadStaff();
  }
}

let kpiChart;
async function loadKPI(){
  const tbody = document.querySelector("#kpiTable tbody");
  tbody.innerHTML = "";
  const snapshot = await db.collection("kpi").get();
  let labels=[], dataPoints=[];
  snapshot.forEach(doc=>{
    const d = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.staff}</td><td>${d.branch}</td><td>${d.customer}</td><td>${d.phone}</td>
    <td>${d.date}</td><td>${d.reg}</td><td>${d.upd}</td><td>${d.app}</td><td>${d.pin}</td>
    <td><button onclick="deleteKPI('${doc.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
    labels.push(d.staff);
    dataPoints.push((d.reg||0)+(d.upd||0)+(d.app||0)+(d.pin||0));
  });

  const ctx = document.getElementById("chart").getContext("2d");
  if(kpiChart) kpiChart.destroy();
  kpiChart = new Chart(ctx,{
    type:'bar',
    data:{labels:labels,datasets:[{label:'Total KPI', data:dataPoints, backgroundColor:'#00796b'}]}
  });
}

async function deleteKPI(id){
  if(confirm("Delete this KPI?")){
    await db.collection("kpi").doc(id).delete();
    loadKPI();
  }
}

async function loadStaffMap(){
  const mapDiv = document.getElementById("map");
  mapDiv.innerHTML = "";
  const map = L.map('map').setView([8.55,39.27],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'Map data Â© OpenStreetMap contributors'
  }).addTo(map);

  const snapshot = await db.collection("users").get();
  snapshot.forEach(doc=>{
    const data = doc.data();
    if(data.lat && data.lng){
      L.marker([data.lat,data.lng]).addTo(map).bindPopup(`${data.name} (${data.role})`);
    }
  });
}

// ---------- EXCEL EXPORT ----------
function exportKPIToExcel(){
  const wb = XLSX.utils.book_new();
  const table = document.getElementById("kpiTable");
  const ws = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws, "KPI");
  XLSX.writeFile(wb, "KPI_Report.xlsx");
}

// ---------- HELPER ----------
function val(id){ return document.getElementById(id).value; }
auth.onAuthStateChanged(u=>{ if(!u) showPage("loginPage"); });
</script>

</body>
</html>
